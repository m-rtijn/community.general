- name: VM add/change/delete NIC
  tags: [ 'nic' ]
  block:
    - name: Add NIC to test VM
      proxmox_nic:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ vmid }}"
        state: present
        interface: net5
        bridge: vmbr0
        tag: 42
      register: results

    - assert:
        that:
        - results is changed
        - results.vmid == {{ vmid }}
        - results.msg == "Nic net5 updated on VM with vmid {{ vmid }}"

    - name: Update NIC no changes
      proxmox_nic:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ vmid }}"
        state: present
        interface: net5
        bridge: vmbr0
        tag: 42
      register: results

    - assert:
        that:
        - results is not changed
        - results.vmid == {{ vmid }}
        - results.msg == "Nic net5 unchanged on VM with vmid {{ vmid }}"

    - name: Update NIC with changes
      proxmox_nic:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ vmid }}"
        state: present
        interface: net5
        bridge: vmbr0
        tag: 24
        firewall: True
      register: results

    - assert:
        that:
        - results is changed
        - results.vmid == {{ vmid }}
        - results.msg == "Nic net5 updated on VM with vmid {{ vmid }}"

    - name: Delete NIC
      proxmox_nic:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ vmid }}"
        state: absent
        interface: net5
      register: results

    - assert:
        that:
        - results is changed
        - results.vmid == {{ vmid }}
        - results.msg == "Nic net5 deleted on VM with vmid {{ vmid }}"
